<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Conecta Quiz ‚Äî Farmacias del Ahorro</title>
  <style>
    :root{
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --card-bg: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --accent-blue: #3b82f6;
      --accent-red: #ef4444;
      --success: #10b981;
      --border: #e2e8f0;
      --shadow: rgba(15, 23, 42, 0.08);
      --primary-red: #ef4444;
      --primary-blue: #3b82f6;
    }
    
    *{box-sizing:border-box}
    
    html,body{
      height:100%;
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      color:var(--text-primary);
      background:linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      position: relative;
    }
    
    .app{
      max-width:980px;
      margin:32px auto;
      padding:24px;
      background:var(--card-bg);
      border-radius:16px;
      box-shadow:0 10px 40px var(--shadow);
      border:1px solid var(--border);
      position: relative;
    }
    
    header{
      display:flex;
      align-items:center;
      gap:16px;
      padding-bottom:24px;
      border-bottom:2px solid var(--border);
      margin-bottom:32px;
    }
    
    .logo{
      height: 60px;
      width: auto;
    }
    
    header h1{
      font-size:28px;
      margin:0;
      font-weight:700;
      color:var(--text-primary);
    }
    
    .subtitle{
      color:var(--text-secondary);
      font-size:14px;
      font-weight:500;
    }
    
    .brand-footer{
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }
    
    .brand-logo{
      height: 32px;
      width: auto;
      opacity: 0.7;
      transition: opacity 0.3s ease;
    }
    
    .brand-logo:hover{
      opacity: 1;
    }
    
    .center{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:20px;
      padding:32px;
    }
    
    .card{
      background:var(--card-bg);
      padding:28px;
      border-radius:12px;
      width:100%;
      border:1px solid var(--border);
    }
    
    .btn{
      display:inline-block;
      padding:16px 32px;
      border-radius:12px;
      background:linear-gradient(135deg, var(--primary-red), #dc2626);
      color:white;
      font-weight:700;
      border:none;
      cursor:pointer;
      font-size:18px;
      transition:all 0.3s ease;
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
    }
    
    .btn:hover{
      background:linear-gradient(135deg, #dc2626, var(--primary-red));
      transform:translateY(-3px);
      box-shadow:0 8px 25px rgba(239, 68, 68, 0.4);
    }
    
    .btn:disabled{
      opacity:0.6;
      cursor:not-allowed;
      transform:none;
      box-shadow: none;
    }
    
    .controls{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      justify-content:center;
    }
    
    .question{
      font-size:24px;
      margin-bottom:20px;
      font-weight:700;
      color:var(--text-primary);
      text-align:center;
      line-height:1.4;
    }
    
    .answers{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
    }
    
    .answer{
      padding:20px;
      border-radius:12px;
      background:var(--bg-secondary);
      cursor:pointer;
      border:2px solid var(--border);
      font-size:16px;
      font-weight:600;
      color:var(--text-primary);
      transition:all 0.3s ease;
      text-align: center;
    }
    
    .answer:hover{
      transform:translateY(-4px);
      box-shadow:0 8px 25px var(--shadow);
      border-color:var(--primary-blue);
      background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
    }
    
    .answer.correct{
      background:linear-gradient(135deg, rgba(59,130,246,0.15), rgba(59,130,246,0.08));
      border-color:var(--primary-blue);
      color:var(--primary-blue);
      font-weight: 700;
    }
    
    .answer.wrong{
      background:linear-gradient(135deg, rgba(239,68,68,0.15), rgba(239,68,68,0.08));
      border-color:var(--primary-red);
      color:var(--primary-red);
      font-weight: 700;
    }
    
    .meta{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:24px;
      color:var(--text-secondary);
      font-size:16px;
      font-weight:600;
    }
    
    .progress{
      height:10px;
      background:var(--border);
      border-radius:5px;
      overflow:hidden;
      margin-top:24px;
    }
    
    .progress > i{
      display:block;
      height:100%;
      width:100%;
      background:linear-gradient(90deg, var(--primary-red), var(--primary-blue));
      transition:width 0.2s ease;
    }
    
    .timer{
      font-weight:800;
      color:var(--primary-red);
      font-size:18px;
    }
    
    .start-screen{
      padding:40px;
      text-align:center;
    }
    
    .start-screen h2{
      font-size:36px;
      margin:0 0 16px 0;
      font-weight:800;
      background:linear-gradient(135deg, var(--primary-red), var(--primary-blue));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    
    .start-screen p{
      font-size:18px;
      color:var(--text-secondary);
      margin:0 0 32px 0;
      line-height:1.6;
    }
    
    .convention-badge{
      background:linear-gradient(135deg, var(--primary-red), var(--primary-blue));
      color:white;
      padding:8px 16px;
      border-radius:20px;
      font-size:14px;
      font-weight:600;
      display:inline-block;
      margin-bottom:16px;
    }
    
    .results{
      padding:40px;
      text-align:center;
    }
    
    .results h2{
      font-size:36px;
      margin:0 0 16px 0;
      font-weight:800;
      background:linear-gradient(135deg, var(--primary-red), var(--primary-blue));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    
    .results p{
      font-size:20px;
      color:var(--text-secondary);
      margin:0 0 32px 0;
    }
    
    .score-display{
      background:linear-gradient(135deg, #f8fafc, #e2e8f0);
      border:2px solid var(--primary-blue);
      border-radius:16px;
      padding:24px;
      margin:20px 0;
      font-size:28px;
      font-weight:800;
      color:var(--primary-blue);
    }
    
    .loading{
      color:var(--accent-blue);
      font-size:16px;
      font-weight:500;
    }
    
    .error{
      color:var(--accent-red);
      font-size:16px;
      padding:16px;
      background:rgba(239,68,68,0.08);
      border-radius:8px;
      border:1px solid rgba(239,68,68,0.2);
    }
    
    .success-message{
      color:var(--primary-blue);
      font-size:16px;
      font-weight:500;
    }
    
    @media(max-width:600px){
      .answers{grid-template-columns:1fr}
      .app{margin:16px; padding:20px}
      .start-screen, .results{padding:24px}
      .logo{height: 48px;}
      .start-screen h2{font-size:28px}
      .brand-footer{bottom: 10px; right: 10px;}
      .brand-logo{height: 24px;}
    }
  </style>
</head>
<body>
  <div class="app" role="main">
    <header>
      <img src="logoHoot.jpeg" alt="Logo" class="logo" />
      <div>
        <div class="convention-badge">Convenci√≥n Conecta 2024</div>
        <div class="subtitle">Quiz Interactivo - Farmacias del Ahorro</div>
      </div>
    </header>

    <main class="center card" id="app">

      <div id="start" class="start-screen">
        <h2>¬°Bienvenido al Quiz Conecta!</h2>
        <p>Pon a prueba tus conocimientos sobre Farmacias del Ahorro. Responde correctamente antes de que se acabe el tiempo y demuestra tu experiencia.</p>
        <div class="controls">
          <button class="btn" id="startBtn">üöÄ Comenzar Quiz</button>
        </div>
        <div id="loadingDiv" class="loading" style="display:none">‚è≥ Preparando preguntas...</div>
        <div id="errorDiv" class="error" style="display:none"></div>
      </div>

      <div id="questionArea" style="display:none;width:100%">
        <div class="meta">
          <div>Pregunta <span id="qindex">1</span> de <span id="qtotal">1</span></div>
          <div class="timer">‚è± <span id="time">15</span>s</div>
        </div>

        <div>
          <div class="question" id="questionText">Cargando pregunta...</div>
          <div class="answers" id="answers"></div>
        </div>

        <div class="progress" aria-hidden><i id="prog"></i></div>
      </div>

      <div id="results" class="results" style="display:none">
        <h2 id="scoreTitle">¬°Felicitaciones!</h2>
        <div class="score-display">
          <div id="scoreText">Tu puntuaci√≥n aparecer√° aqu√≠</div>
        </div>
        <p style="color:var(--primary-blue); font-weight:600;">¬°Gracias por participar en la Convenci√≥n Conecta!</p>
        <div id="saveStatus" class="loading" style="display:none; margin-top:16px"></div>
      </div>

    </main>
  </div>

  <!-- Brand logo in bottom right -->
  <div class="brand-footer">
    <img src="logooIO.png" alt="Powered by" class="brand-logo" />
  </div>

  <script>
    // üîß CONFIGURACI√ìN DEL JUEGO
    const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwiBFpQCAs1PZFPLF8LvQTjtmBuYywun8V0t1vzf5SGX7mHtAMkTwvaGUDGpyhCGmg4-w/exec';
    const timePerQuestion = 15; // segundos por pregunta

    // Variables del juego
    let QUESTIONS = [];
    let index = 0, score = 0, timer = null, timeLeft = timePerQuestion;
    let gameDetails = []; // Para guardar detalles de cada respuesta

    // Elementos DOM
    const startBtn = document.getElementById('startBtn');
    const startArea = document.getElementById('start');
    const qArea = document.getElementById('questionArea');
    const results = document.getElementById('results');
    const qIndex = document.getElementById('qindex');
    const qTotal = document.getElementById('qtotal');
    const qText = document.getElementById('questionText');
    const answers = document.getElementById('answers');
    const timeEl = document.getElementById('time');
    const prog = document.getElementById('prog');
    const scoreText = document.getElementById('scoreText');
    const scoreTitle = document.getElementById('scoreTitle');
    const loadingDiv = document.getElementById('loadingDiv');
    const errorDiv = document.getElementById('errorDiv');
    const saveStatus = document.getElementById('saveStatus');

    // Funci√≥n para cargar preguntas desde Google Sheets
    async function loadQuestionsFromSheets() {
      try {
        loadingDiv.style.display = 'block';
        errorDiv.style.display = 'none';
        startBtn.disabled = true;
        
        const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getQuestions`);
        
        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error);
        }
        
        if (data.questions && data.questions.length > 0) {
          QUESTIONS = data.questions;
          loadingDiv.style.display = 'none';
          showMessage('‚úÖ Preguntas cargadas correctamente', 'success');
          return true;
        } else {
          throw new Error('No se encontraron preguntas en Google Sheets');
        }
      } catch (error) {
        console.error('Error cargando preguntas:', error);
        loadingDiv.style.display = 'none';
        errorDiv.innerHTML = `‚ùå Error al conectar con Google Sheets: ${error.message}`;
        errorDiv.style.display = 'block';
        return false;
      } finally {
        startBtn.disabled = false;
      }
    }

    // Funci√≥n para guardar resultados en Google Sheets
    async function saveResultsToSheets(gameData) {
      try {
        saveStatus.textContent = 'üíæ Guardando resultados...';
        saveStatus.style.display = 'block';
        saveStatus.className = 'loading';

        const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'saveResults',
            score: gameData.score,
            total: gameData.total,
            details: gameData.details
          })
        });

        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status}`);
        }

        const result = await response.json();
        
        if (result.success) {
          saveStatus.textContent = '‚úÖ Resultados guardados correctamente';
          saveStatus.className = 'success-message';
          setTimeout(() => saveStatus.style.display = 'none', 4000);
        } else {
          throw new Error(result.message || 'Error desconocido');
        }
      } catch (error) {
        console.error('Error guardando resultados:', error);
        saveStatus.textContent = '‚ùå Error al guardar resultados';
        saveStatus.className = 'error';
        saveStatus.style.display = 'block';
      }
    }

    function showMessage(message, type = 'info') {
      const div = document.createElement('div');
      div.innerHTML = message;
      div.className = type === 'success' ? 'success-message' : 'loading';
      div.style.position = 'fixed';
      div.style.top = '24px';
      div.style.left = '50%';
      div.style.transform = 'translateX(-50%)';
      div.style.padding = '16px 20px';
      div.style.borderRadius = '8px';
      div.style.zIndex = '1000';
      div.style.backgroundColor = 'white';
      div.style.boxShadow = '0 6px 20px rgba(0,0,0,0.15)';
      div.style.border = '1px solid var(--border)';
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 3500);
    }

    async function startGame() {
      startBtn.disabled = true;
      startBtn.textContent = 'üöÄ Cargando...';
      
      // Cargar preguntas desde Google Sheets
      const loaded = await loadQuestionsFromSheets();
      
      if (!loaded || QUESTIONS.length === 0) {
        startBtn.disabled = false;
        startBtn.textContent = 'üöÄ Comenzar Quiz';
        return;
      }
      
      setTimeout(() => {
        // Inicializar juego
        index = 0; 
        score = 0;
        gameDetails = [];
        qTotal.textContent = QUESTIONS.length;
        startArea.style.display = 'none';
        results.style.display = 'none';
        qArea.style.display = 'block';
        startBtn.disabled = false;
        startBtn.textContent = 'üöÄ Comenzar Quiz';
        
        showQuestion();
      }, 800);
    }

    function showQuestion() {
      clearTimer();
      const cur = QUESTIONS[index];
      qIndex.textContent = index + 1;
      qText.textContent = cur.q;
      answers.innerHTML = '';
      
      cur.choices.forEach((c, i) => {
        const btn = document.createElement('button');
        btn.className = 'answer';
        btn.textContent = c;
        btn.dataset.index = i;
        btn.onclick = () => selectAnswer(i, btn);
        answers.appendChild(btn);
      });
      
      timeLeft = timePerQuestion;
      updateTimerVisual();
      timer = setInterval(tick, 200);
    }

    function tick() {
      timeLeft -= 0.2;
      if (timeLeft <= 0) {
        timeLeft = 0;
        clearTimer();
        timeoutAnswer();
      }
      updateTimerVisual();
    }

    function updateTimerVisual() {
      timeEl.textContent = Math.ceil(timeLeft);
      const pct = Math.max(0, timeLeft / timePerQuestion);
      prog.style.width = Math.round(pct * 100) + '%';
    }

    function clearTimer() {
      if (timer) {
        clearInterval(timer);
        timer = null;
      }
    }

    function selectAnswer(i, btnEl) {
      clearTimer();
      const cur = QUESTIONS[index];
      const correct = cur.answer;
      const isCorrect = i === correct;
      
      // Guardar detalles de la respuesta
      gameDetails.push({
        question: cur.q,
        selectedAnswer: cur.choices[i],
        correctAnswer: cur.choices[correct],
        isCorrect: isCorrect,
        timeUsed: Math.round((timePerQuestion - timeLeft) * 10) / 10
      });

      // Marcar botones
      [...answers.children].forEach(b => {
        b.disabled = true;
        b.style.cursor = 'default';
        if (Number(b.dataset.index) === correct) b.classList.add('correct');
      });

      if (isCorrect) {
        score++;
        btnEl.classList.add('correct');
      } else {
        btnEl.classList.add('wrong');
      }

      setTimeout(nextQuestion, 1500);
    }

    function timeoutAnswer() {
      const cur = QUESTIONS[index];
      
      // Guardar detalles del timeout
      gameDetails.push({
        question: cur.q,
        selectedAnswer: 'Sin respuesta (tiempo agotado)',
        correctAnswer: cur.choices[cur.answer],
        isCorrect: false,
        timeUsed: timePerQuestion,
        timeout: true
      });

      [...answers.children].forEach(b => {
        b.disabled = true;
        b.style.cursor = 'default';
        if (Number(b.dataset.index) === cur.answer) b.classList.add('correct');
      });
      
      setTimeout(nextQuestion, 1500);
    }

    function nextQuestion() {
      index++;
      if (index >= QUESTIONS.length) endGame();
      else showQuestion();
    }

    function endGame() {
      clearTimer();
      qArea.style.display = 'none';
      results.style.display = 'block';
      
      const percentage = Math.round((score/QUESTIONS.length)*100);
      
      if (percentage >= 80) {
        scoreTitle.textContent = '¬°Excelente conocimiento!';
      } else if (percentage >= 60) {
        scoreTitle.textContent = '¬°Muy buen trabajo!';
      } else if (percentage >= 40) {
        scoreTitle.textContent = '¬°Buen intento!';
      } else {
        scoreTitle.textContent = '¬°Sigue aprendiendo!';
      }
      
      scoreText.innerHTML = `
        <div style="font-size:48px; margin-bottom:8px;">${score}/${QUESTIONS.length}</div>
        <div style="font-size:20px;">${percentage}% Correcto</div>
      `;
      
      const gameData = {
        score: score,
        total: QUESTIONS.length,
        details: gameDetails
      };
      
      await saveResultsToSheets(gameData);
    }

    // Event listeners
    startBtn.addEventListener('click', startGame);

    // Accesibilidad con teclado
    window.addEventListener('keydown', (e) => {
      if (qArea.style.display === 'block') {
        const k = parseInt(e.key);
        if (!isNaN(k) && k >= 1 && k <= 4) {
          const btn = answers.children[k - 1];
          if (btn && !btn.disabled) btn.click();
        }
      }
    });

    // Animaci√≥n de entrada
    window.addEventListener('load', () => {
      document.querySelector('.app').style.opacity = '0';
      document.querySelector('.app').style.transform = 'translateY(20px)';
      setTimeout(() => {
        document.querySelector('.app').style.transition = 'all 0.6s ease';
        document.querySelector('.app').style.opacity = '1';
        document.querySelector('.app').style.transform = 'translateY(0)';
      }, 100);
    });

  </script>
</body>
</html>