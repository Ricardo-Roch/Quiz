<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mini-Kahoot ‚Äî Quiz interactivo</title>
  <style>
    :root{--bg:#0f172a;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--correct:#10b981;--wrong:#ef4444}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#e6eef6;background:linear-gradient(180deg,#071029 0%, #071732 100%)}
    .app{max-width:980px;margin:32px auto;padding:18px;background:rgba(255,255,255,0.02);border-radius:12px;box-shadow:0 6px 30px rgba(2,6,23,0.6)}
    header{display:flex;align-items:center;gap:12px}
    header h1{font-size:20px;margin:0}
    .center{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;padding:28px}
    .card{background:var(--card);padding:20px;border-radius:10px;width:100%;}
    .btn{display:inline-block;padding:10px 16px;border-radius:8px;background:var(--accent);color:#052022;font-weight:600;border:none;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .btn:disabled{opacity:0.5;cursor:not-allowed}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .question{font-size:18px;margin-bottom:12px}
    .answers{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .answer{padding:12px;border-radius:8px;background:rgba(255,255,255,0.02);cursor:pointer;border:1px solid rgba(255,255,255,0.03)}
    .answer:hover{transform:translateY(-3px);transition:all .12s}
    .answer.correct{background:linear-gradient(90deg, rgba(16,185,129,0.12), rgba(16,185,129,0.06));border-color:rgba(16,185,129,0.22)}
    .answer.wrong{background:linear-gradient(90deg, rgba(239,68,68,0.08), rgba(239,68,68,0.04));border-color:rgba(239,68,68,0.16)}
    .meta{display:flex;justify-content:space-between;align-items:center;margin-top:12px;color:var(--muted);font-size:14px}
    .progress{height:10px;background:rgba(255,255,255,0.03);border-radius:999px;overflow:hidden}
    .progress > i{display:block;height:100%;width:100%;background:linear-gradient(90deg,var(--accent),#7dd3fc)}
    .timer{font-weight:700}
    .start-screen{padding:20px;text-align:center}
    .results{padding:20px;text-align:center}
    .loading{color:var(--accent);font-size:14px}
    .error{color:var(--wrong);font-size:14px;padding:10px;background:rgba(239,68,68,0.1);border-radius:6px}
    footer{margin-top:12px;color:var(--muted);font-size:13px;text-align:center}
    @media(max-width:600px){.answers{grid-template-columns:1fr}.app{margin:12px}}
  </style>
</head>
<body>
  <div class="app" role="main">
    <header>
      <svg width="36" height="36" viewBox="0 0 24 24" fill="none" aria-hidden>
        <rect width="24" height="24" rx="6" fill="#052022"/>
        <path d="M6 9h12v2H6zM6 13h8v2H6z" fill="#06b6d4"/>
      </svg>
      <div>
        <h1>Mini-Kahoot ‚Äî Quiz interactivo</h1>
        <div style="color:var(--muted);font-size:13px">Conectado con Google Sheets</div>
      </div>
    </header>

    <main class="center card" id="app">

      <div id="start" class="start-screen">
        <h2 style="margin:0 0 6px 0">¬°Listo para jugar?</h2>
        <p style="margin:0 0 12px;color:var(--muted)">Las preguntas se cargan desde Google Sheets. Responde antes de que se acabe el tiempo.</p>
        <div class="controls">
          <button class="btn" id="startBtn">Cargar preguntas y jugar</button>
          <button class="btn ghost" id="editBtn">Editar preguntas locales</button>
        </div>
        <div id="loadingDiv" class="loading" style="display:none">Cargando preguntas desde Google Sheets...</div>
        <div id="errorDiv" class="error" style="display:none"></div>
      </div>

      <div id="questionArea" style="display:none;width:100%">
        <div class="meta">
          <div>Pregunta <span id="qindex">1</span>/<span id="qtotal">1</span></div>
          <div class="timer">‚è± <span id="time">10</span>s</div>
        </div>

        <div style="margin-top:12px">
          <div class="question" id="questionText">Texto de la pregunta</div>
          <div class="answers" id="answers"></div>
        </div>

        <div style="margin-top:14px">
          <div class="progress" aria-hidden><i id="prog"></i></div>
        </div>

      </div>

      <div id="results" class="results" style="display:none">
        <h2 id="scoreTitle">Resultados</h2>
        <p id="scoreText" style="color:var(--muted)"></p>
        <div style="margin-top:12px">
          <button class="btn" id="replayBtn">Jugar de nuevo</button>
          <button class="btn ghost" id="downloadBtn">Descargar resultados</button>
        </div>
        <div id="saveStatus" class="loading" style="display:none; margin-top:8px"></div>
      </div>

      <div id="editor" style="display:none;width:100%;margin-top:12px">
        <label style="font-size:14px;color:var(--muted)">Editar JSON de preguntas locales (backup)</label>
        <textarea id="jsonInput" style="width:100%;height:140px;margin-top:8px;background:#0b1220;color:#e6eef6;border:1px solid rgba(255,255,255,0.03);padding:10px;border-radius:8px;font-family:monospace;font-size:13px"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="saveJson">Guardar localmente</button>
          <button class="btn ghost" id="closeEditor">Cerrar</button>
        </div>
      </div>

    </main>

    <footer>
      <p>üìä Los resultados se guardan autom√°ticamente en Google Sheets</p>
      <p style="font-size:11px">Configura tu Google Apps Script URL abajo ‚¨áÔ∏è</p>
    </footer>
  </div>

  <script>
    // üîß CONFIGURACI√ìN IMPORTANTE - CAMBIA ESTA URL
    // Obt√©n esta URL despu√©s de publicar tu Google Apps Script
    const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwiBFpQCAs1PZFPLF8LvQTjtmBuYywun8V0t1vzf5SGX7mHtAMkTwvaGUDGpyhCGmg4-w/exec';
    
    // Configuraci√≥n local (backup)
    const timePerQuestion = 12;
    const FALLBACK_QUESTIONS = [
      {q: '¬ø?', choices: ['Guadalajara','Monterrey','Ciudad de M√©xico','Puebla'], answer: 2},
      {q: '¬ø?', choices: ['Python','HTML','C++','Swift'], answer: 1},
      {q: '¬ø?', choices: ['3','4','5','22'], answer: 1}
    ];

    // Variables del juego
    let QUESTIONS = [...FALLBACK_QUESTIONS];
    let index = 0, score = 0, timer = null, timeLeft = timePerQuestion;
    let gameDetails = []; // Para guardar detalles de cada respuesta

    // Elementos DOM
    const startBtn = document.getElementById('startBtn');
    const editBtn = document.getElementById('editBtn');
    const startArea = document.getElementById('start');
    const qArea = document.getElementById('questionArea');
    const results = document.getElementById('results');
    const qIndex = document.getElementById('qindex');
    const qTotal = document.getElementById('qtotal');
    const qText = document.getElementById('questionText');
    const answers = document.getElementById('answers');
    const timeEl = document.getElementById('time');
    const prog = document.getElementById('prog');
    const replayBtn = document.getElementById('replayBtn');
    const scoreText = document.getElementById('scoreText');
    const scoreTitle = document.getElementById('scoreTitle');
    const downloadBtn = document.getElementById('downloadBtn');
    const editArea = document.getElementById('editor');
    const jsonInput = document.getElementById('jsonInput');
    const saveJson = document.getElementById('saveJson');
    const closeEditor = document.getElementById('closeEditor');
    const loadingDiv = document.getElementById('loadingDiv');
    const errorDiv = document.getElementById('errorDiv');
    const saveStatus = document.getElementById('saveStatus');

    // Inicializar
    jsonInput.value = JSON.stringify(FALLBACK_QUESTIONS, null, 2);

    // Funci√≥n para cargar preguntas desde Google Sheets
    async function loadQuestionsFromSheets() {
      if (!GOOGLE_APPS_SCRIPT_URL.includes('TU_SCRIPT_ID_AQUI')) {
        try {
          loadingDiv.style.display = 'block';
          errorDiv.style.display = 'none';
          
          const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getQuestions`);
          const data = await response.json();
          
          if (data.error) {
            throw new Error(data.error);
          }
          
          if (data.questions && data.questions.length > 0) {
            QUESTIONS = data.questions;
            loadingDiv.style.display = 'none';
            showMessage('‚úÖ Preguntas cargadas desde Google Sheets', 'success');
            return true;
          } else {
            throw new Error('No se encontraron preguntas en el Google Sheet');
          }
        } catch (error) {
          console.error('Error cargando preguntas:', error);
          loadingDiv.style.display = 'none';
          showError(`Error al cargar desde Google Sheets: ${error.message}\nUsando preguntas locales.`);
          QUESTIONS = [...FALLBACK_QUESTIONS];
          return false;
        }
      } else {
        showError('‚ö†Ô∏è Configura tu Google Apps Script URL en el c√≥digo');
        QUESTIONS = [...FALLBACK_QUESTIONS];
        return false;
      }
    }

    // Funci√≥n para guardar resultados en Google Sheets
    async function saveResultsToSheets(gameData) {
      if (!GOOGLE_APPS_SCRIPT_URL.includes('TU_SCRIPT_ID_AQUI')) {
        try {
          saveStatus.textContent = 'Guardando resultados...';
          saveStatus.style.display = 'block';

          const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              action: 'saveResults',
              score: gameData.score,
              total: gameData.total,
              details: gameData.details
            })
          });

          const result = await response.json();
          
          if (result.success) {
            saveStatus.textContent = '‚úÖ Resultados guardados en Google Sheets';
            setTimeout(() => saveStatus.style.display = 'none', 3000);
          } else {
            throw new Error(result.message || 'Error desconocido');
          }
        } catch (error) {
          console.error('Error guardando resultados:', error);
          saveStatus.textContent = '‚ùå Error al guardar en Google Sheets';
          saveStatus.style.color = 'var(--wrong)';
        }
      }
    }

    function showError(message) {
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => errorDiv.style.display = 'none', 5000);
    }

    function showMessage(message, type = 'info') {
      const div = document.createElement('div');
      div.textContent = message;
      div.className = type === 'success' ? 'loading' : 'error';
      div.style.position = 'fixed';
      div.style.top = '20px';
      div.style.right = '20px';
      div.style.padding = '10px';
      div.style.borderRadius = '6px';
      div.style.zIndex = '1000';
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 3000);
    }

    async function startGame() {
      startBtn.disabled = true;
      
      // Cargar preguntas desde Google Sheets
      await loadQuestionsFromSheets();
      
      // Inicializar juego
      index = 0; 
      score = 0;
      gameDetails = [];
      qTotal.textContent = QUESTIONS.length;
      startArea.style.display = 'none';
      results.style.display = 'none';
      editArea.style.display = 'none';
      qArea.style.display = 'block';
      startBtn.disabled = false;
      
      showQuestion();
    }

    function showQuestion() {
      clearTimer();
      const cur = QUESTIONS[index];
      qIndex.textContent = index + 1;
      qText.textContent = cur.q;
      answers.innerHTML = '';
      
      cur.choices.forEach((c, i) => {
        const btn = document.createElement('button');
        btn.className = 'answer';
        btn.textContent = c;
        btn.dataset.index = i;
        btn.onclick = () => selectAnswer(i, btn);
        answers.appendChild(btn);
      });
      
      timeLeft = timePerQuestion;
      updateTimerVisual();
      timer = setInterval(tick, 200);
    }

    function tick() {
      timeLeft -= 0.2;
      if (timeLeft <= 0) {
        timeLeft = 0;
        clearTimer();
        timeoutAnswer();
      }
      updateTimerVisual();
    }

    function updateTimerVisual() {
      timeEl.textContent = Math.ceil(timeLeft);
      const pct = Math.max(0, timeLeft / timePerQuestion);
      prog.style.width = Math.round(pct * 100) + '%';
    }

    function clearTimer() {
      if (timer) {
        clearInterval(timer);
        timer = null;
      }
    }

    function selectAnswer(i, btnEl) {
      clearTimer();
      const cur = QUESTIONS[index];
      const correct = cur.answer;
      const isCorrect = i === correct;
      
      // Guardar detalles de la respuesta
      gameDetails.push({
        question: cur.q,
        selectedAnswer: cur.choices[i],
        correctAnswer: cur.choices[correct],
        isCorrect: isCorrect,
        timeUsed: timePerQuestion - timeLeft
      });

      // Marcar botones
      [...answers.children].forEach(b => {
        b.disabled = true;
        if (Number(b.dataset.index) === correct) b.classList.add('correct');
      });

      if (isCorrect) {
        score++;
        btnEl.classList.add('correct');
      } else {
        btnEl.classList.add('wrong');
      }

      setTimeout(nextQuestion, 900);
    }

    function timeoutAnswer() {
      const cur = QUESTIONS[index];
      
      // Guardar detalles del timeout
      gameDetails.push({
        question: cur.q,
        selectedAnswer: null,
        correctAnswer: cur.choices[cur.answer],
        isCorrect: false,
        timeUsed: timePerQuestion,
        timeout: true
      });

      [...answers.children].forEach(b => {
        b.disabled = true;
        if (Number(b.dataset.index) === cur.answer) b.classList.add('correct');
      });
      
      setTimeout(nextQuestion, 900);
    }

    function nextQuestion() {
      index++;
      if (index >= QUESTIONS.length) endGame();
      else showQuestion();
    }

    async function endGame() {
      clearTimer();
      qArea.style.display = 'none';
      results.style.display = 'block';
      scoreTitle.textContent = '¬°Terminado!';
      scoreText.textContent = `Obtuviste ${score} de ${QUESTIONS.length} respuestas correctas (${Math.round((score/QUESTIONS.length)*100)}%).`;
      
      // Guardar resultados en Google Sheets
      const gameData = {
        score: score,
        total: QUESTIONS.length,
        details: gameDetails
      };
      
      await saveResultsToSheets(gameData);
    }

    // Event listeners
    startBtn.addEventListener('click', startGame);
    replayBtn.addEventListener('click', startGame);
    editBtn.addEventListener('click', () => {
      editArea.style.display = 'block';
      jsonInput.focus();
    });
    closeEditor.addEventListener('click', () => editArea.style.display = 'none');

    saveJson.addEventListener('click', () => {
      try {
        const parsed = JSON.parse(jsonInput.value);
        if (!Array.isArray(parsed)) throw new Error('Se requiere un array de preguntas');
        QUESTIONS.length = 0;
        parsed.forEach(p => QUESTIONS.push(p));
        qTotal.textContent = QUESTIONS.length;
        showMessage('‚úÖ Preguntas locales guardadas', 'success');
      } catch (err) {
        showError('JSON inv√°lido: ' + err.message);
      }
    });

    downloadBtn.addEventListener('click', () => {
      const data = {
        score,
        total: QUESTIONS.length,
        percentage: Math.round((score/QUESTIONS.length)*100),
        date: new Date().toISOString(),
        details: gameDetails
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'resultados_quiz_' + new Date().toISOString().split('T')[0] + '.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    // Accesibilidad con teclado
    window.addEventListener('keydown', (e) => {
      if (qArea.style.display === 'block') {
        const k = parseInt(e.key);
        if (!isNaN(k) && k >= 1 && k <= 4) {
          const btn = answers.children[k - 1];
          if (btn && !btn.disabled) btn.click();
        }
      }
    });

    // Cargar preguntas al inicio para verificar conexi√≥n
    document.addEventListener('DOMContentLoaded', () => {
      if (!GOOGLE_APPS_SCRIPT_URL.includes('TU_SCRIPT_ID_AQUI')) {
        loadQuestionsFromSheets();
      }
    });

  </script>
</body>
</html>